<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Mappa 2D Posizione Audio</title>
  <style>
    canvas {
      border: 1px solid #ccc;
      background: #f8f8f8;
      display: inline-block;
      margin: 20px;
    }
    body {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <canvas id="mapCanvas" width="400" height="400"></canvas>
  <canvas id="sideCanvas" width="400" height="400"></canvas>

  <script type="module">
    import { io } from './libs/socket.io/packages/socket.io/client-dist/socket.io.esm.min.js';

    const mapCanvas = document.getElementById('mapCanvas');
    const mapCtx = mapCanvas.getContext('2d');
    const sideCanvas = document.getElementById('sideCanvas');
    const sideCtx = sideCanvas.getContext('2d');

    const socket = io();
    socket.emit('receiver-ready'); // ðŸ” Richiesta posizioni iniziali cubi

    const positions = {
      1: { x: 0, y: 0, z: 0 },
      2: { x: 0, y: 0, z: 0 },
      listeners: {}
    };

    function drawTopView() {
      mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
      mapCtx.save();
      mapCtx.translate(mapCanvas.width / 2, mapCanvas.height / 2);

      mapCtx.fillStyle = 'red';
      mapCtx.fillRect(positions[1].x * 20 - 5, positions[1].z * 20 - 5, 10, 10);
      mapCtx.font = '12px sans-serif';
      mapCtx.fillText(`(${positions[1].x.toFixed(1)}, ${positions[1].z.toFixed(1)})`, positions[1].x * 20 - 20, positions[1].z * 20 - 10);

      mapCtx.fillStyle = 'green';
      mapCtx.fillRect(positions[2].x * 20 - 5, positions[2].z * 20 - 5, 10, 10);
      mapCtx.fillText(`(${positions[2].x.toFixed(1)}, ${positions[2].z.toFixed(1)})`, positions[2].x * 20 - 20, positions[2].z * 20 - 10);

      for (const id in positions.listeners) {
        const pos = positions.listeners[id];
        const xPix = pos.x * 20;
        const zPix = pos.z * 20;

        mapCtx.fillStyle = 'blue';
        mapCtx.beginPath();
        mapCtx.arc(xPix, zPix, 6, 0, 2 * Math.PI);
        mapCtx.fill();
        mapCtx.fillText(`${id.slice(0, 6)}`, xPix + 8, zPix);
        mapCtx.fillText(`(${pos.x.toFixed(1)}, ${pos.z.toFixed(1)})`, xPix - 20, zPix - 10);
      }

      mapCtx.restore();
    }

    function drawSideView() {
      sideCtx.clearRect(0, 0, sideCanvas.width, sideCanvas.height);
      sideCtx.save();
      sideCtx.translate(sideCanvas.width / 2, sideCanvas.height / 2);

      sideCtx.fillStyle = 'red';
      sideCtx.fillRect(positions[1].x * 20 - 5, -positions[1].y * 20 - 5, 10, 10);
      sideCtx.font = '12px sans-serif';
      sideCtx.fillText(`(${positions[1].x.toFixed(1)}, ${positions[1].y.toFixed(1)})`, positions[1].x * 20 - 20, -positions[1].y * 20 - 10);

      sideCtx.fillStyle = 'green';
      sideCtx.fillRect(positions[2].x * 20 - 5, -positions[2].y * 20 - 5, 10, 10);
      sideCtx.fillText(`(${positions[2].x.toFixed(1)}, ${positions[2].y.toFixed(1)})`, positions[2].x * 20 - 20, -positions[2].y * 20 - 10);

      for (const id in positions.listeners) {
        const pos = positions.listeners[id];
        const xPix = pos.x * 20;
        const yPix = -pos.y * 20;

        sideCtx.fillStyle = 'blue';
        sideCtx.beginPath();
        sideCtx.arc(xPix, yPix, 6, 0, 2 * Math.PI);
        sideCtx.fill();
        sideCtx.fillText(`${id.slice(0, 6)}`, xPix + 8, yPix);
        sideCtx.fillText(`(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`, xPix - 20, yPix - 10);
      }

      sideCtx.restore();
    }

    function draw() {
      drawTopView();
      drawSideView();
    }

    socket.on('move-cube', ({ index, x, y, z }) => {
      positions[index] = { x, y, z };
      draw();
    });

    socket.on('listener-position', ({ id, x, y = 0, z }) => {
      positions.listeners[id] = { x, y, z };
      draw();
    });

    socket.on('listener-disconnected', (id) => {
      delete positions.listeners[id];
      draw();
    });

    draw();
  </script>
</body>
</html>